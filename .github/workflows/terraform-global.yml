name: Terraform Global Infrastructure

on:
  # Plan on push to main and develop
  push:
    branches:
      - main
      - develop
    paths:
      - 'global-infrastructure/**'
      - '.github/workflows/terraform-global.yml'
  
  # Plan on PRs to main and develop
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'global-infrastructure/**'
      - '.github/workflows/terraform-global.yml'
  
  # Manual trigger for apply/destroy
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      confirm:
        description: 'Type "yes" to confirm apply/destroy'
        required: false
        type: string

env:
  # ====================================================================
  # Configuration - Update these for your project
  # ====================================================================
  PROJECT_NAME: pipeops
  TF_VERSION: '1.5.0'
  
  # Region Configuration
  PRIMARY_REGION: us-west-2
  
  # Backend Configuration
  BACKEND_BUCKET: pipeops-global-terraform-state
  BACKEND_KEY: global/terraform.tfstate
  BACKEND_DYNAMODB: pipeops-global-terraform-locks

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  terraform-global:
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy') && 'global' || '' }}
    
    defaults:
      run:
        working-directory: ./global-infrastructure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate confirmation
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy')
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "yes" ]; then
            echo "‚ùå ERROR: You must type 'yes' to confirm ${{ github.event.inputs.action }}"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          role-session-name: github-actions-global-${{ github.run_id }}
          aws-region: ${{ env.PRIMARY_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check if backend exists
        id: check-backend
        run: |
          if aws s3 ls s3://${{ env.BACKEND_BUCKET }} --region ${{ env.PRIMARY_REGION }} 2>&1 | grep -q 'NoSuchBucket'; then
            echo "backend_exists=false" >> $GITHUB_OUTPUT
          else
            echo "backend_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup backend prerequisites
        if: steps.check-backend.outputs.backend_exists == 'false'
        run: |
          echo "Creating S3 bucket for global state..."
          aws s3api create-bucket \
            --bucket ${{ env.BACKEND_BUCKET }} \
            --region ${{ env.PRIMARY_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.PRIMARY_REGION }}
          
          aws s3api put-bucket-versioning \
            --bucket ${{ env.BACKEND_BUCKET }} \
            --versioning-configuration Status=Enabled
          
          aws s3api put-bucket-encryption \
            --bucket ${{ env.BACKEND_BUCKET }} \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          
          echo "Creating DynamoDB table for locking..."
          aws dynamodb create-table \
            --table-name ${{ env.BACKEND_DYNAMODB }} \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ env.PRIMARY_REGION }} || true

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ env.BACKEND_BUCKET }}" \
            -backend-config="key=${{ env.BACKEND_KEY }}" \
            -backend-config="region=${{ env.PRIMARY_REGION }}" \
            -backend-config="dynamodb_table=${{ env.BACKEND_DYNAMODB }}" \
            -backend-config="encrypt=true"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="environments/prod/terraform.tfvars" \
            -out=tfplan-global \
            -no-color | tee plan-output.txt

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-global-${{ github.run_number }}
          path: |
            global-infrastructure/tfplan-global
            global-infrastructure/plan-output.txt
          retention-days: 5

      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('global-infrastructure/plan-output.txt', 'utf8');
            const output = `#### Terraform Plan for \`Global Infrastructure\` üåç
            
            <details>
            <summary>Show Plan</summary>
            
            \`\`\`terraform
            ${plan.length > 65000 ? plan.substring(0, 65000) + '...\n[Plan output truncated]' : plan}
            \`\`\`
            
            </details>
            
            **Components:**
            - Route53 Hosted Zone & DNS Records
            - ACM Certificates (Primary + DR)
            - Health Checks & Failover Configuration
            
            > ‚ö†Ô∏è **Note:** Apply via workflow_dispatch only
            
            *Pusher: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Plan Summary
        if: github.event_name == 'push'
        run: |
          echo "## üåç Global Infrastructure Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components" >> $GITHUB_STEP_SUMMARY
          echo "- Route53 DNS Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- ACM Certificates (Primary + DR)" >> $GITHUB_STEP_SUMMARY
          echo "- Health Checks & Failover" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Apply via workflow_dispatch" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Apply
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          terraform apply -auto-approve tfplan-global

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        run: |
          terraform destroy \
            -var-file="environments/prod/terraform.tfvars" \
            -auto-approve

      - name: Capture outputs
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        run: |
          echo "## ‚úÖ Global Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Certificate ARNs" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary:** \`$(terraform output -raw primary_certificate_arn 2>/dev/null || echo 'N/A')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **DR:** \`$(terraform output -raw dr_certificate_arn 2>/dev/null || echo 'N/A')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DNS" >> $GITHUB_STEP_SUMMARY
          echo "- **Hosted Zone:** \`$(terraform output -raw hosted_zone_id 2>/dev/null || echo 'N/A')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **App FQDN:** \`$(terraform output -raw app_fqdn 2>/dev/null || echo 'N/A')\`" >> $GITHUB_STEP_SUMMARY
          
          terraform output -json > outputs-global.json

      - name: Upload outputs
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: outputs-global-${{ github.run_number }}
          path: global-infrastructure/outputs-global.json
          retention-days: 30
