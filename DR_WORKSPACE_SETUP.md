# ğŸŒ DR Workspace Setup - Complete Guide

## Overview

The DR (Disaster Recovery) infrastructure has been reorganized into a **completely separate Terraform workspace** for better isolation, management, and deployment control.

## ğŸ¯ What Changed

### Before (Integrated Approach)
```
pipeops-project-iac/
â”œâ”€â”€ main.tf              # Primary + DR (conditional)
â”œâ”€â”€ dr-main.tf           # DR resources
â””â”€â”€ variables.tf         # Mixed variables
```

**Issues:**
- DR and primary infrastructure mixed in same state
- Conditional logic (`count = var.environment == "prod" ? 1 : 0`)
- Harder to manage independently
- Single point of failure for state

### After (Separate Workspace)
```
pipeops-project-iac/
â”œâ”€â”€ main.tf                    # Primary infrastructure only
â”œâ”€â”€ variables.tf               # Primary variables
â”‚
â””â”€â”€ dr-infrastructure/         # â† NEW: Separate workspace
    â”œâ”€â”€ main.tf                # DR infrastructure
    â”œâ”€â”€ variables.tf           # DR-specific variables
    â”œâ”€â”€ outputs.tf             # DR outputs
    â”œâ”€â”€ versions.tf            # DR backend config
    â”œâ”€â”€ environments/
    â”‚   â””â”€â”€ prod/
    â”‚       â”œâ”€â”€ terraform.tfvars
    â”‚       â””â”€â”€ backend.conf
    â””â”€â”€ scripts/
        â”œâ”€â”€ setup-dr-prerequisites.sh
        â””â”€â”€ deploy-dr.sh
```

**Benefits:**
- âœ… Complete isolation of DR infrastructure
- âœ… Independent state management
- âœ… Separate deployment lifecycle
- âœ… No conditional logic
- âœ… Easier to manage and test
- âœ… Better security (separate state access)

## ğŸ“ New Structure

### DR Workspace Components

```
dr-infrastructure/
â”‚
â”œâ”€â”€ README.md                    # DR workspace documentation
â”œâ”€â”€ .gitignore                   # DR-specific gitignore
â”‚
â”œâ”€â”€ main.tf                      # DR VPC + EKS + Controllers
â”œâ”€â”€ variables.tf                 # DR configuration variables
â”œâ”€â”€ outputs.tf                   # DR cluster outputs
â”œâ”€â”€ versions.tf                  # Terraform & provider versions
â”‚
â”œâ”€â”€ environments/
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ terraform.tfvars     # Production DR config
â”‚       â””â”€â”€ backend.conf         # Generated by setup script
â”‚
â””â”€â”€ scripts/
    â”œâ”€â”€ setup-dr-prerequisites.sh  # Setup S3 backend & DynamoDB
    â””â”€â”€ deploy-dr.sh               # Deploy/manage DR infrastructure
```

### Shared Modules

The DR workspace reuses modules from the parent directory:

```
pipeops-project-iac/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ vpc/          # â† Shared by primary & DR
â”‚   â”œâ”€â”€ eks/          # â† Shared by primary & DR
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ dr-infrastructure/
    â””â”€â”€ main.tf       # References ../modules/
```

## ğŸš€ Deployment Workflow

### Complete Setup (First Time)

#### 1. Deploy Primary Infrastructure

```bash
# In root directory
./scripts/setup-prerequisites.sh prod us-west-2
./scripts/deploy.sh prod apply
```

This creates:
- Primary VPC in us-west-2
- Primary EKS cluster
- RDS with cross-region DR replica
- All primary infrastructure

#### 2. Setup DR Workspace

```bash
# Switch to DR workspace
cd dr-infrastructure

# Setup DR backend (separate S3 bucket & DynamoDB)
./scripts/setup-dr-prerequisites.sh prod us-east-1
```

This creates:
- S3 bucket: `pipeops-terraform-state-dr-<account-id>`
- DynamoDB table: `terraform-state-lock-dr`
- Backend config: `environments/prod/backend.conf`

#### 3. Deploy DR Infrastructure

```bash
# Still in dr-infrastructure/
./scripts/deploy-dr.sh prod plan
./scripts/deploy-dr.sh prod apply
```

This creates:
- DR VPC in us-east-1
- DR EKS cluster (standby mode)
- DR controllers and add-ons

### Ongoing Management

#### Update Primary Infrastructure

```bash
# In root directory
./scripts/deploy.sh prod plan
./scripts/deploy.sh prod apply
```

#### Update DR Infrastructure

```bash
# In dr-infrastructure/
cd dr-infrastructure
./scripts/deploy-dr.sh prod plan
./scripts/deploy-dr.sh prod apply
```

#### View DR Status

```bash
cd dr-infrastructure
./scripts/deploy-dr.sh prod output
```

## ğŸ”„ State Management

### Separate State Files

**Primary State:**
- Bucket: `pipeops-terraform-state-prod-<account-id>`
- Key: `pipeops-project-iac-prod-terraform.tfstate`
- Region: `us-west-2`
- DynamoDB: `terraform-state-lock-prod`

**DR State:**
- Bucket: `pipeops-terraform-state-dr-<account-id>`
- Key: `pipeops-project-iac-dr-terraform.tfstate`
- Region: `us-east-1`
- DynamoDB: `terraform-state-lock-dr`

### Benefits of Separate State

1. **Isolation**: DR changes don't affect primary state
2. **Security**: Different IAM permissions for DR access
3. **Reliability**: No single point of failure
4. **Flexibility**: Deploy/destroy DR independently
5. **Testing**: Safe to test DR without risking primary

## ğŸ’° Cost Comparison

### Integrated Approach (Old)
- Single state file
- All resources in one plan
- Harder to estimate DR-specific costs

### Separate Workspace (New)
- Clear cost separation
- Easy to calculate DR costs
- Can destroy DR to save costs when not needed

**DR Infrastructure Costs (Standby Mode):**
```
EKS Cluster:    $73/month
EC2 Nodes:      $60/month (2x t3.medium)
NAT Gateways:   $100/month (3 AZs)
Data Transfer:  $10/month
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:          ~$243/month
```

## ğŸ” Security Improvements

### IAM Separation

**Primary IAM Policy:**
```json
{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "arn:aws:s3:::pipeops-terraform-state-prod-*"
}
```

**DR IAM Policy:**
```json
{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "arn:aws:s3:::pipeops-terraform-state-dr-*"
}
```

### Access Control

- Different teams can manage primary vs DR
- Separate audit trails
- Independent state locking
- Reduced blast radius

## ğŸ“Š Comparison Matrix

| Aspect | Integrated (Old) | Separate Workspace (New) |
|--------|------------------|--------------------------|
| **State Management** | Single state | Separate states |
| **Deployment** | Conditional logic | Independent |
| **Cost Tracking** | Mixed | Clear separation |
| **Security** | Shared access | Isolated access |
| **Testing** | Risky | Safe |
| **Complexity** | Higher | Lower |
| **Maintenance** | Harder | Easier |
| **Blast Radius** | Large | Small |

## ğŸ“ Best Practices

### 1. Deploy Primary First
Always deploy primary infrastructure before DR:
```bash
# 1. Primary
./scripts/deploy.sh prod apply

# 2. Then DR
cd dr-infrastructure
./scripts/deploy-dr.sh prod apply
```

### 2. Keep Versions in Sync
Ensure Kubernetes versions match:
```hcl
# Primary: variables.tf
kubernetes_version = "1.28"

# DR: dr-infrastructure/variables.tf
kubernetes_version = "1.28"  # Must match
```

### 3. Regular Testing
Test DR independently:
```bash
cd dr-infrastructure
./scripts/deploy-dr.sh prod plan  # Safe to test
```

### 4. Separate Access
Use different IAM roles for primary and DR management.

### 5. Document Changes
Update both workspaces when making infrastructure changes.

## ğŸš¨ Migration from Old Setup

If you have the old integrated setup:

### Step 1: Backup Current State
```bash
# Backup primary state
aws s3 cp s3://pipeops-terraform-state-prod-<account-id>/pipeops-project-iac-prod-terraform.tfstate \
  ./backup-state-$(date +%Y%m%d).tfstate
```

### Step 2: Remove DR from Primary
```bash
# In root directory
# Remove dr-main.tf (already done)
# Update main.tf to remove DR provider
# Update variables.tf to remove DR variables
```

### Step 3: Setup New DR Workspace
```bash
cd dr-infrastructure
./scripts/setup-dr-prerequisites.sh prod us-east-1
./scripts/deploy-dr.sh prod plan
```

### Step 4: Import Existing DR Resources (if any)
```bash
# If you have existing DR resources, import them
terraform import module.dr_vpc.aws_vpc.main <vpc-id>
terraform import module.dr_eks.aws_eks_cluster.main <cluster-name>
# ... etc
```

## ğŸ“š Documentation Structure

```
pipeops-project-iac/
â”œâ”€â”€ README.md                          # Main project README
â”œâ”€â”€ RDS_COMPLETE_GUIDE.md              # RDS HA/DR guide
â”œâ”€â”€ ENVIRONMENT_DEPLOYMENT_GUIDE.md    # Primary deployment
â”œâ”€â”€ QUICK_START.md                     # Quick reference
â”œâ”€â”€ DR_WORKSPACE_SETUP.md              # This file
â”‚
â””â”€â”€ dr-infrastructure/
    â”œâ”€â”€ README.md                      # DR workspace guide
    â””â”€â”€ ...
```

## ğŸ”„ Typical Workflows

### Deploy Everything (First Time)
```bash
# 1. Primary infrastructure
./scripts/setup-prerequisites.sh prod us-west-2
./scripts/deploy.sh prod apply

# 2. DR infrastructure
cd dr-infrastructure
./scripts/setup-dr-prerequisites.sh prod us-east-1
./scripts/deploy-dr.sh prod apply
```

### Update Primary Only
```bash
./scripts/deploy.sh prod plan
./scripts/deploy.sh prod apply
```

### Update DR Only
```bash
cd dr-infrastructure
./scripts/deploy-dr.sh prod plan
./scripts/deploy-dr.sh prod apply
```

### Scale Up DR for Activation
```bash
cd dr-infrastructure
# Edit environments/prod/terraform.tfvars
# Change: dr_desired_capacity = 6
./scripts/deploy-dr.sh prod apply
```

### Destroy DR (Cost Savings)
```bash
cd dr-infrastructure
./scripts/deploy-dr.sh prod destroy
```

### Recreate DR Later
```bash
cd dr-infrastructure
./scripts/deploy-dr.sh prod apply
```

## ğŸ¯ Key Takeaways

1. **Separation of Concerns**: Primary and DR are now completely independent
2. **Easier Management**: Deploy, test, and destroy DR without affecting primary
3. **Better Security**: Separate state files and access controls
4. **Cost Control**: Easy to calculate and optimize DR costs
5. **Flexibility**: Can destroy DR when not needed, recreate when required
6. **Testing**: Safe to test DR infrastructure independently
7. **Scalability**: Easy to add more DR regions in the future

## ğŸ“ Support

### Primary Infrastructure Issues
- Check: `README.md`, `ENVIRONMENT_DEPLOYMENT_GUIDE.md`
- Logs: Root directory Terraform logs

### DR Infrastructure Issues
- Check: `dr-infrastructure/README.md`
- Logs: `dr-infrastructure/` Terraform logs

### RDS DR Issues
- Check: `RDS_COMPLETE_GUIDE.md`
- RDS is managed by primary workspace

---

**Summary**: The DR infrastructure is now a completely separate, independently managed Terraform workspace. This provides better isolation, security, and flexibility for disaster recovery management.
